<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --color-teal-300: rgba(50, 184, 198, 1);
        --color-teal-400: rgba(45, 166, 178, 1);
        --color-teal-500: rgba(33, 128, 141, 1);
        --color-teal-600: rgba(29, 116, 128, 1);
        --color-slate-900: rgba(19, 52, 59, 1);
        --color-gray-200: rgba(245, 245, 245, 1);
        --color-gray-300: rgba(167, 169, 169, 1);
        --color-charcoal-700: rgba(31, 33, 33, 1);
        --color-charcoal-800: rgba(38, 40, 40, 1);
        --color-red-400: rgba(255, 84, 89, 1);
        --color-orange-400: rgba(230, 129, 97, 1);

        --color-background: rgba(252, 252, 249, 1);
        --color-text: var(--color-slate-900);
        --color-text-secondary: rgba(98, 108, 113, 1);
        --color-primary: var(--color-teal-500);
        --color-primary-hover: var(--color-teal-600);
        --color-success: var(--color-teal-500);
        --color-error: rgba(192, 21, 47, 1);

        --font-family-base:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --space-4: 4px;
        --space-8: 8px;
        --space-12: 12px;
        --space-16: 16px;
        --space-20: 20px;
        --space-24: 24px;
        --space-32: 32px;
        --radius-base: 8px;
        --radius-lg: 12px;
        --radius-full: 9999px;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --color-background: var(--color-charcoal-700);
          --color-text: var(--color-gray-200);
          --color-text-secondary: rgba(167, 169, 169, 0.7);
          --color-primary: var(--color-teal-300);
          --color-primary-hover: var(--color-teal-400);
          --color-success: var(--color-teal-300);
          --color-error: var(--color-red-400);
        }
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-family-base);
        background: var(--color-background);
        color: var(--color-text);
        line-height: 1.5;
      }

      h3 {
        padding-bottom: 10px;
      }
      .bg-particles {
        position: fixed;
        inset: 0;
        background: linear-gradient(
          135deg,
          rgba(59, 130, 246, 0.08),
          rgba(6, 182, 212, 0.08)
        );
        z-index: -1;
        opacity: 0.3;
        animation: float 20s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0);
        }

        50% {
          transform: translateY(-20px);
        }
      }

      .glass-card {
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: var(--radius-lg);
        padding: var(--space-24);
        transition: all 0.25s ease;
      }

      .glass-card:hover {
        background: rgba(255, 255, 255, 0.12);
        transform: translateY(-2px);
      }

      .header {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        padding: var(--space-16);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .header-content {
        max-width: 1280px;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-24);
      }

      .logo-section {
        display: flex;
        align-items: center;
        gap: var(--space-16);
      }

      .logo-icon {
        font-size: 2rem;
      }

      .logo-text h1 {
        font-size: 1.25rem;
        font-weight: 600;
        background: linear-gradient(
          135deg,
          var(--color-primary),
          var(--color-teal-300)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .logo-text p {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
      }

      .header-actions {
        display: flex;
        gap: var(--space-12);
      }

      .location-select,
      .notification-btn,
      .export-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: var(--radius-full);
        padding: var(--space-8) var(--space-16);
        color: var(--color-text);
        cursor: pointer;
        transition: all 0.2s;
      }

      .location-select:hover,
      .notification-btn:hover,
      .export-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.05);
      }

      .location-select option {
        color: rgba(0, 0, 0, 0.8);
      }

      .nav-tabs {
        position: fixed;
        top: 73px;
        left: 0;
        right: 0;
        z-index: 999;
        display: flex;
        justify-content: center;
        padding: var(--space-12);
      }

      .tab-buttons {
        display: flex;
        gap: var(--space-4);
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: var(--radius-full);
        padding: var(--space-4);
        position: relative;
      }

      .tab-buttons::before {
        content: "";
        position: absolute;
        top: var(--space-4);
        left: var(--space-4);
        height: calc(100% - 8px);
        background: rgba(31, 184, 205, 0.15);
        border-radius: var(--radius-full);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 0;
        width: var(--tab-width, 140px);
        transform: translateX(var(--tab-offset, 0px));
      }

      .tab-button {
        display: flex;
        align-items: center;
        gap: var(--space-8);
        padding: var(--space-12) var(--space-20);
        background: transparent;
        border: none;
        border-radius: var(--radius-full);
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: color 0.25s;
        position: relative;
        z-index: 1;
      }

      .tab-button:hover {
        color: var(--color-text);
      }

      .tab-button.active {
        color: var(--color-primary);
      }

      .main-content {
        max-width: 1280px;
        margin: 0 auto;
        padding: 140px var(--space-16) var(--space-32);
      }

      .tab-content {
        display: none;
        animation: fadeIn 0.5s;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .dashboard-hero {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: var(--space-24);
        margin-bottom: var(--space-32);
      }

      .aqi-hero-content {
        display: flex;
        gap: var(--space-32);
        align-items: center;
      }

      .aqi-circular-progress {
        position: relative;
        width: 200px;
        height: 200px;
      }

      .aqi-circle {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }

      .aqi-value {
        font-size: 3rem;
        font-weight: 700;
        background: linear-gradient(
          135deg,
          var(--color-primary),
          var(--color-teal-400)
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .progress-ring {
        transform: rotate(-90deg);
      }

      .progress-ring-bg,
      .progress-ring-fill {
        fill: none;
        stroke-width: 4;
      }

      .progress-ring-bg {
        stroke: rgba(255, 255, 255, 0.1);
      }

      .progress-ring-fill {
        stroke: var(--color-primary);
        stroke-linecap: round;
        stroke-dasharray: 502;
        stroke-dashoffset: 502;
        transition: stroke-dashoffset 1s ease;
        filter: drop-shadow(0 0 8px rgba(31, 184, 205, 0.4));
      }

      .quick-stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--space-16);
      }

      .stat-card {
        display: flex;
        align-items: center;
        gap: var(--space-16);
        padding: var(--space-20);
      }

      .stat-icon {
        font-size: 2rem;
      }

      .stat-value {
        font-size: 1.25rem;
        font-weight: 600;
      }

      .stat-label {
        font-size: 0.75rem;
        color: var(--color-text-secondary);
        text-transform: uppercase;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: var(--space-24);
      }

      .pollutant-gauges {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--space-20);
      }

      .pollutant-gauge {
        text-align: center;
        transition: transform 0.25s;
      }

      .pollutant-gauge:hover {
        transform: translateY(-8px);
      }

      .gauge-circle {
        position: relative;
        width: 100px;
        height: 100px;
        margin: 0 auto var(--space-12);
      }

      .gauge-bg,
      .gauge-fill {
        position: absolute;
        inset: 0;
        border-radius: 50%;
      }

      .gauge-bg {
        background: conic-gradient(
          rgba(255, 255, 255, 0.1),
          rgba(255, 255, 255, 0.05)
        );
        border: 2px solid rgba(255, 255, 255, 0.1);
      }

      .gauge-fill {
        background: conic-gradient(
          var(--color-primary),
          transparent var(--gauge-percentage, 0%)
        );
        mask: radial-gradient(circle, transparent 30px, black 31px);
        transition: background 1s ease;
      }

      .gauge-value {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: 600;
      }

      .forecast-timeline {
        display: flex;
        gap: var(--space-16);
        overflow-x: auto;
        scroll-snap-type: x mandatory;
        flex-wrap: wrap;
        padding: var(--space-8) 0;
      }

      .timeline-item {
        flex-shrink: 0;
        min-width: 80px;
        padding: var(--space-12);
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: var(--radius-base);
        text-align: center;
        scroll-snap-align: center;
        transition: all 0.2s;
      }

      .timeline-item:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateY(-2px);
      }

      .timeline-aqi {
        font-size: 1.5rem;
        font-weight: 600;
        margin: var(--space-4) 0;
      }

      .chart-container {
        position: relative;
        height: 300px;
      }

      .map-visualization {
        position: relative;
        height: 500px;
        background: linear-gradient(135deg, #1e3a8a, #3b82f6, #60a5fa, #93c5fd);
        border-radius: var(--radius-lg);
        overflow: hidden;
      }

      .map-marker {
        position: absolute;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
        color: white;
        transition: all 0.2s;
        animation: markerPulse 2s ease-in-out infinite;
      }

      .map-marker:hover {
        transform: scale(1.3);
        z-index: 10;
      }

      .map-marker.selected {
        transform: scale(1.5);
        z-index: 11;
      }

      @keyframes markerPulse {
        0%,
        100% {
          box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4);
        }

        50% {
          box-shadow: 0 0 0 10px rgba(255, 255, 255, 0);
        }
      }

      .map-marker.aqi-good {
        background: #10b981;
      }

      .map-marker.aqi-moderate {
        background: #f59e0b;
      }

      .map-marker.aqi-unhealthy_sensitive {
        background: #f97316;
      }

      .map-marker.aqi-unhealthy {
        background: #dc2626;
      }

      .map-marker[data-city="New York City"] {
        top: 25%;
        left: 85%;
      }

      .map-marker[data-city="Los Angeles"] {
        top: 70%;
        left: 15%;
      }

      .map-marker[data-city="Chicago"] {
        top: 35%;
        left: 70%;
      }

      .map-marker[data-city="Houston"] {
        top: 75%;
        left: 50%;
      }

      .map-marker[data-city="Phoenix"] {
        top: 70%;
        left: 25%;
      }

      .map-marker[data-city="Philadelphia"] {
        top: 30%;
        left: 83%;
      }

      .map-marker[data-city="Atlanta"] {
        top: 55%;
        left: 75%;
      }

      .map-marker[data-city="Seattle"] {
        top: 15%;
        left: 20%;
      }

      .map-tooltip {
        position: fixed;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: var(--space-12);
        border-radius: var(--radius-base);
        font-size: 0.875rem;
        pointer-events: none;
        z-index: 2000;
        opacity: 0;
        transition: opacity 0.2s;
      }

      .map-tooltip.visible {
        opacity: 1;
      }

      .monitoring-locations {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: var(--space-16);
      }

      .location-card {
        padding: var(--space-20);
        cursor: pointer;
        position: relative;
      }

      .location-card.selected {
        border-color: var(--color-primary);
        background: rgba(31, 184, 205, 0.1);
      }

      .location-aqi {
        font-size: 2rem;
        font-weight: 600;
        margin: var(--space-8) 0;
      }

      .toast-container {
        position: fixed;
        top: 140px;
        right: var(--space-24);
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: var(--space-12);
      }

      .toast {
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        color: white;
        padding: var(--space-16);
        border-radius: var(--radius-base);
        max-width: 300px;
        animation: slideIn 0.3s;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }

        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .skeleton {
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.05) 25%,
          rgba(255, 255, 255, 0.1) 50%,
          rgba(255, 255, 255, 0.05) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        border-radius: var(--radius-base);
        height: 20px;
      }

      @keyframes shimmer {
        0% {
          background-position: -200% 0;
        }

        100% {
          background-position: 200% 0;
        }
      }

      @media (max-width: 768px) {
        .dashboard-hero {
          grid-template-columns: 1fr;
        }

        .aqi-hero-content {
          flex-direction: column;
        }

        .quick-stats-grid {
          grid-template-columns: 1fr;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
        }

        .tab-button span:not(.tab-icon) {
          display: none;
        }

        .status-dot.pulsing {
          display: inline-block;
          width: 10px;
          height: 10px;
          border-radius: 50%;
          background-color: var(--color-primary);
          animation: pulse 1.5s infinite;
          margin-right: 8px;
          vertical-align: middle;
        }

        @keyframes pulse {
          0% {
            transform: scale(1);
            opacity: 0.7;
          }

          50% {
            transform: scale(1.5);
            opacity: 0.3;
          }

          100% {
            transform: scale(1);
            opacity: 0.7;
          }
        }

        #notificationPanel {
          opacity: 0;
          transform: translateY(-10px);
          transition:
            opacity 0.25s ease,
            transform 0.25s ease;
        }

        #notificationPanel.visible {
          display: block;
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>

  <body>
    <div class="bg-particles"></div>

    <header class="header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo-icon">üõ∞Ô∏è</div>
          <div class="logo-text">
            <h1>AirFlow Intelligence</h1>
          </div>
        </div>
        <div class="header-actions">
          <select
            id="locationSelect"
            class="location-select"
            aria-label="Select location"
          >
            <option value="0">New York City</option>
            <option value="1">Los Angeles</option>
            <option value="2">Chicago</option>
            <option value="3">Houston</option>
            <option value="4">Phoenix</option>
            <option value="5">Philadelphia</option>
            <option value="6">Atlanta</option>
            <option value="7">Seattle</option>
          </select>
          <button class="export-btn" id="exportBtn" aria-label="Export data">
            üìä
          </button>
          <button
            class="notification-btn"
            id="notificationBtn"
            aria-label="Notifications"
          >
            <span>üîî</span>
            <span class="notification-dot"></span>
          </button>
        </div>
      </div>
    </header>

    <nav class="nav-tabs">
      <div class="tab-buttons" role="tablist">
        <button
          class="tab-button active"
          data-tab="dashboard"
          role="tab"
          aria-selected="true"
          aria-label="Dashboard"
        >
          <span class="tab-icon">üìä</span>
          <span>Dashboard</span>
        </button>
        <button
          class="tab-button"
          data-tab="map"
          role="tab"
          aria-selected="false"
          aria-label="Live Map"
        >
          <span class="tab-icon">üó∫Ô∏è</span>
          <span>Live Map</span>
        </button>
        <button
          class="tab-button"
          data-tab="forecast"
          role="tab"
          aria-selected="false"
          aria-label="Forecast"
        >
          <span class="tab-icon">üìà</span>
          <span>Forecast</span>
        </button>
      </div>
    </nav>

    <main class="main-content">
      <section id="dashboard" class="tab-content active" role="tabpanel">
        <div class="dashboard-hero">
          <div class="glass-card">
            <div class="aqi-hero-content">
              <div class="aqi-circular-progress">
                <svg class="progress-ring" width="200" height="200">
                  <circle
                    cx="100"
                    cy="100"
                    r="80"
                    class="progress-ring-bg"
                  ></circle>
                  <circle
                    cx="100"
                    cy="100"
                    r="80"
                    class="progress-ring-fill"
                    id="progressCircle"
                  ></circle>
                </svg>
                <div class="aqi-circle">
                  <div class="aqi-value" id="aqiValue">128</div>
                  <div class="aqi-label">AQI</div>
                </div>
              </div>
              <div class="aqi-details">
                <h2 id="aqiCategory">Unhealthy for Sensitive</h2>
                <p id="aqiLocation">üìç New York City</p>
                <div class="aqi-status">
                  <span class="status-dot pulsing"></span>
                </div>
                <p id="dominantPollutant">Primary: PM2.5 ‚Ä¢ 33.03 ¬µg/m¬≥</p>
              </div>
            </div>
          </div>

          <div class="quick-stats-grid">
            <div class="glass-card stat-card">
              <div class="stat-icon">üå°Ô∏è</div>
              <div class="stat-content">
                <div class="stat-value" id="temperature">22¬∞C</div>
                <div class="stat-label">Temperature</div>
              </div>
            </div>
            <div class="glass-card stat-card">
              <div class="stat-icon">üí®</div>
              <div class="stat-content">
                <div class="stat-value" id="windSpeed">12 km/h</div>
                <div class="stat-label">Wind Speed</div>
              </div>
            </div>
            <div class="glass-card stat-card">
              <div class="stat-icon">üíß</div>
              <div class="stat-content">
                <div class="stat-value" id="humidity">65%</div>
                <div class="stat-label">Humidity</div>
              </div>
            </div>
            <div class="glass-card stat-card">
              <div class="stat-icon">‚è∞</div>
              <div class="stat-content">
                <div class="stat-value" id="lastUpdate">Now</div>
                <div class="stat-label">Updated</div>
              </div>
            </div>
          </div>
        </div>

        <div class="dashboard-grid">
          <div class="glass-card">
            <h3>Pollutant Levels</h3>
            <div class="pollutant-gauges" id="pollutantGauges"></div>
          </div>

          <div class="glass-card">
            <h3>12-Hour Preview</h3>
            <div class="forecast-timeline" id="forecastTimeline"></div>
          </div>

          <div class="glass-card" style="grid-column: 1 / -1">
            <h3>24-Hour Trend</h3>
            <div class="chart-container">
              <canvas id="historicalChart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <section id="map" class="tab-content" role="tabpanel">
        <div class="glass-card" style="margin-bottom: var(--space-24)">
          <h2>Live Air Quality Map</h2>
        </div>

        <div class="map-visualization" id="mapVisualization"></div>
        <div
          class="monitoring-locations"
          id="monitoringLocations"
          style="margin-top: var(--space-24)"
        ></div>
      </section>

      <section id="forecast" class="tab-content" role="tabpanel">
        <div class="glass-card" style="margin-bottom: var(--space-24)">
          <h2>72-Hour Forecast</h2>
        </div>

        <div class="glass-card">
          <h3>AQI Forecast</h3>
          <div class="chart-container">
            <canvas id="forecastChart"></canvas>
          </div>
        </div>
      </section>
      <div
        id="notificationPanel"
        class="glass-card"
        style="
          position: fixed;
          top: 70px;
          right: 24px;
          width: 300px;
          display: none;
          z-index: 2000;
        "
      >
        <h4>Notifications</h4>
        <ul
          id="notificationList"
          style="list-style: none; padding-left: 0; font-size: 0.875rem"
        >
          <!-- Dynamic notifications will appear here -->
        </ul>
      </div>
    </main>

    <div class="map-tooltip" id="mapTooltip"></div>
    <div class="toast-container" id="toastContainer"></div>

    <script>
      function getOutdoorAdvice(current) {
        const aqi = current.aqi;
        const temp = current.weather.temperature;
        const humidity = current.weather.humidity;
        const wind = current.weather.wind_speed;

        let advice = "";

        // Check AQI first
        if (aqi <= 50) advice += "Air quality is good. ";
        else if (aqi <= 100)
          advice +=
            "Air quality is moderate. Sensitive people should take care. ";
        else if (aqi <= 150)
          advice +=
            "Air quality is unhealthy for sensitive groups. Consider limiting outdoor activity. ";
        else if (aqi <= 200)
          advice += "Air quality is unhealthy. Limit outdoor activity. ";
        else if (aqi <= 300)
          advice +=
            "Air quality is very unhealthy. Avoid going outside if possible. ";
        else advice += "Air quality is hazardous. Stay indoors. ";

        // Temperature advice
        if (temp >= 35) advice += "It's very hot, stay hydrated. ";
        else if (temp <= 5) advice += "It's very cold, dress warmly. ";

        // Humidity and wind can also add small notes
        if (humidity > 80) advice += "High humidity might feel uncomfortable. ";
        if (wind > 20) advice += "Strong winds today, be careful outdoors. ";

        return advice;
      }

      class AirFlowIntelligence {
        constructor() {
          this.currentLocationIndex = 0;
          this.charts = {};
          this.data = null;
          this.isLoading = false;
          this.mapTooltip = null;
          this.compareMode = false;
          this.init();
        }

        async init() {
          try {
            await this.loadData();
            this.setupEventListeners();
            this.setupKeyboardNavigation();
            this.updateDashboard();
            this.renderMap();
            this.renderCharts();
            this.startRealTimeUpdates();
            this.showToast("Welcome to AirFlow Intelligence!");
          } catch (error) {
            console.error("Init failed:", error);
            this.showToast("Failed to load data", "error");
          }
        }

        async loadData(cityName = "New York City") {
          await this.simulateLoading(1);

          try {
            // === CONFIG ===
            const apiKey = "798044554d1b14cd0b6208587d8d02d0"; // Replace with your actual API key
            const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(cityName)}&units=metric&appid=${apiKey}`;

            // === FETCH WEATHER DATA ===
            const response = await fetch(apiUrl);
            if (!response.ok) {
              console.error("API error:", await response.text());
              throw new Error(
                `Weather API request failed (${response.status})`,
              );
            }

            const weatherData = await response.json();

            // === EXTRACT WEATHER FIELDS ===
            const temperature = weatherData.main.temp;
            const humidity = weatherData.main.humidity;
            const windSpeed = weatherData.wind.speed;
            const lat = weatherData.coord.lat;
            const lon = weatherData.coord.lon;

            // === MOCK AQI / POLLUTANTS ===
            const randomAQI = Math.floor(50 + Math.random() * 100);
            const pollutants = {
              NO2: {
                value: (10 + Math.random() * 30).toFixed(2),
                unit: "¬µg/m¬≥",
              },
              O3: {
                value: (50 + Math.random() * 80).toFixed(2),
                unit: "¬µg/m¬≥",
              },
              "PM2.5": {
                value: (20 + Math.random() * 20).toFixed(2),
                unit: "¬µg/m¬≥",
              },
              PM10: {
                value: (15 + Math.random() * 25).toFixed(2),
                unit: "¬µg/m¬≥",
              },
              SO2: { value: (3 + Math.random() * 5).toFixed(2), unit: "¬µg/m¬≥" },
              CO: {
                value: (0.5 + Math.random() * 1.5).toFixed(2),
                unit: "mg/m¬≥",
              },
            };

            // === STORE INTO EXISTING DATA STRUCTURE ===
            this.data = {
              air_quality_data: {
                current_conditions: {
                  timestamp: new Date().toISOString(),
                  location: { name: cityName, lat, lon },
                  aqi: randomAQI,
                  dominant_pollutant: "PM2.5",
                  pollutants,
                  weather: {
                    temperature,
                    humidity,
                    wind_speed: windSpeed,
                  },
                },
                historical_data: this.generateHistoricalData(),
                forecast_data: this.generateForecastData(),
              },
              monitoring_locations: [
                {
                  id: 1,
                  name: cityName,
                  lat,
                  lon,
                  aqi: randomAQI,
                  trend: "stable",
                },
              ],
            };
          } catch (error) {
            console.error("Error loading data:", error);
            this.showToast(
              "Failed to load live weather data. Showing fallback data.",
              "error",
            );

            // Fallback to static default data
            this.data = {
              air_quality_data: {
                current_conditions: {
                  timestamp: new Date().toISOString(),
                  location: {
                    name: "New York City",
                    lat: 40.7128,
                    lon: -74.006,
                  },
                  aqi: 128,
                  dominant_pollutant: "PM2.5",
                  pollutants: {
                    NO2: { value: 26.02, unit: "¬µg/m¬≥" },
                    O3: { value: 110.15, unit: "¬µg/m¬≥" },
                    "PM2.5": { value: 33.03, unit: "¬µg/m¬≥" },
                    PM10: { value: 26.75, unit: "¬µg/m¬≥" },
                    SO2: { value: 5.65, unit: "¬µg/m¬≥" },
                    CO: { value: 1.98, unit: "mg/m¬≥" },
                  },
                  weather: { temperature: 22, humidity: 65, wind_speed: 12 },
                },
                historical_data: this.generateHistoricalData(),
                forecast_data: this.generateForecastData(),
              },
              monitoring_locations: [
                {
                  id: 1,
                  name: "New York City",
                  lat: 40.7128,
                  lon: -74.006,
                  aqi: 128,
                  trend: "stable",
                },
              ],
            };
          }
        }
        generateHistoricalData() {
          const data = [];
          const now = new Date();
          for (let i = 23; i >= 0; i--) {
            const timestamp = new Date(now.getTime() - i * 60 * 60 * 1000);
            data.push({
              timestamp: timestamp.toISOString(),
              aqi: Math.round(70 + Math.sin(i * 0.3) * 30 + Math.random() * 20),
            });
          }
          return data;
        }

        generateForecastData() {
          const data = [];
          const now = new Date();
          for (let i = 1; i <= 72; i++) {
            const timestamp = new Date(now.getTime() + i * 60 * 60 * 1000);
            data.push({
              timestamp: timestamp.toISOString(),
              aqi: Math.round(80 + Math.sin(i * 0.2) * 25 + Math.random() * 15),
              confidence: 0.75 + Math.random() * 0.2,
            });
          }
          return data;
        }
        updateNotifications() {
          const list = document.getElementById("notificationList");
          if (!list || !this.data) return;

          const current = this.data.air_quality_data.current_conditions;

          // Get advice
          const advice = getOutdoorAdvice(current);

          list.innerHTML = `
        <li><strong>Location:</strong> ${current.location.name}</li>
        <li><strong>AQI:</strong> ${current.aqi} (${this.getAQICategoryName(this.getAQICategory(current.aqi))})</li>
        <li><strong>Primary Pollutant:</strong> ${current.dominant_pollutant} ‚Ä¢ ${current.pollutants[current.dominant_pollutant].value} ${current.pollutants[current.dominant_pollutant].unit}</li>
        <li><strong>Temperature:</strong> ${current.weather.temperature}¬∞C</li>
        <li><strong>Humidity:</strong> ${current.weather.humidity}%</li>
        <li><strong>Wind Speed:</strong> ${current.weather.wind_speed} km/h</li>
        <li><strong>Last Update:</strong> ${new Date(current.timestamp).toLocaleTimeString()}</li>
        <li><strong>Advice:</strong> ${advice}</li>
    `;
        }

        setupEventListeners() {
          document
            .getElementById("locationSelect")
            ?.addEventListener("change", (e) => {
              this.currentLocationIndex = parseInt(e.target.value);
              this.updateLocation();
            });

          document
            .getElementById("exportBtn")
            ?.addEventListener("click", () => this.exportData());
          document
            .getElementById("notificationBtn")
            ?.addEventListener("click", () => {
              const panel = document.getElementById("notificationPanel");
              panel.style.display =
                panel.style.display === "block" ? "none" : "block";
              this.updateNotifications(); // <-- Populate with details
            });

          const notificationBtn = document.getElementById("notificationBtn");
          const notificationPanel =
            document.getElementById("notificationPanel");

          notificationBtn.addEventListener("click", () => {
            notificationPanel.classList.toggle("visible");
          });

          document.querySelectorAll(".tab-button").forEach((button, index) => {
            button.addEventListener("click", () => {
              this.switchTab(button.dataset.tab, index);
            });
          });

          // Initialize tab indicator position
          this.updateTabIndicator(0);
        }

        updateTabIndicator(index) {
          const buttons = document.querySelectorAll(".tab-button");
          const tabButtons = document.querySelector(".tab-buttons");
          if (!buttons[index] || !tabButtons) return;

          const button = buttons[index];
          const buttonWidth = button.offsetWidth;
          const buttonLeft = button.offsetLeft;

          tabButtons.style.setProperty("--tab-width", `${buttonWidth}px`);
          tabButtons.style.setProperty("--tab-offset", `${buttonLeft}px`);
        }

        setupKeyboardNavigation() {
          document.addEventListener("keydown", (e) => {
            if (e.key === "ArrowLeft" || e.key === "ArrowRight") {
              this.navigateLocations(e.key === "ArrowRight" ? 1 : -1);
            }
          });
        }

        navigateLocations(direction) {
          const newIndex = this.currentLocationIndex + direction;
          if (
            newIndex >= 0 &&
            newIndex < this.data.monitoring_locations.length
          ) {
            this.currentLocationIndex = newIndex;
            document.getElementById("locationSelect").value = newIndex;
            this.updateLocation();
          }
        }

        switchTab(tabId, index) {
          document.querySelectorAll(".tab-button").forEach((btn) => {
            btn.classList.remove("active");
            btn.setAttribute("aria-selected", "false");
          });
          document
            .querySelectorAll(".tab-content")
            .forEach((content) => content.classList.remove("active"));

          const activeButton = document.querySelector(`[data-tab="${tabId}"]`);
          const activeContent = document.getElementById(tabId);

          if (activeButton && activeContent) {
            activeButton.classList.add("active");
            activeButton.setAttribute("aria-selected", "true");
            activeContent.classList.add("active");

            // Animate tab indicator
            if (typeof index !== "undefined") {
              this.updateTabIndicator(index);
            }

            if (tabId === "forecast") this.renderForecastChart();
            if (tabId === "map") this.renderMap();
          }
        }

        debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        }

        async updateLocation() {
          this.isLoading = true;
          await this.simulateLoading(500);

          const locationSelect = document.getElementById("locationSelect");
          const selectedOption =
            locationSelect.options[locationSelect.selectedIndex];
          const cityName = selectedOption.text;

          // Fetch new live data for the selected city
          await this.loadData(cityName);

          this.updateDashboard();
          this.renderMap();
          if (this.charts.historical) {
            this.charts.historical.destroy();
            this.renderCharts();
          }

          this.isLoading = false;
          this.showToast(`Location updated: ${cityName}`);
        }

        updateDashboard() {
          const current = this.data.air_quality_data.current_conditions;
          this.updateAQIProgress(current.aqi);

          // Get AQI category
          const category = this.getAQICategory(current.aqi);

          // Update AQI display
          document.getElementById("aqiValue").textContent = current.aqi;
          document.getElementById("aqiCategory").textContent =
            this.getAQICategoryName(category);
          document.getElementById("aqiLocation").textContent =
            `üìç ${current.location.name}`;
          document.getElementById("dominantPollutant").textContent =
            `Primary: ${current.dominant_pollutant} ‚Ä¢ ${current.pollutants[current.dominant_pollutant].value} ${current.pollutants[current.dominant_pollutant].unit}`;

          document.getElementById("temperature").textContent =
            `${current.weather.temperature}¬∞C`;
          document.getElementById("windSpeed").textContent =
            `${current.weather.wind_speed} km/h`;
          document.getElementById("humidity").textContent =
            `${current.weather.humidity}%`;
          document.getElementById("lastUpdate").textContent =
            new Date().toLocaleTimeString("en-US", {
              hour: "numeric",
              minute: "2-digit",
            });

          if (category === "unhealthy" || category === "very_unhealthy") {
            this.showToast(
              `‚ö†Ô∏è Dangerous Air Quality! AQI: ${current.aqi}`,
              "error",
            );
          }

          this.updatePollutantGauges(current.pollutants);
          this.updateForecastTimeline();
        }

        updateAQIProgress(aqi) {
          const circle = document.getElementById("progressCircle");
          if (!circle) return;

          const percentage = Math.min(aqi / 300, 1);
          const circumference = 2 * Math.PI * 80;
          const offset = circumference - percentage * circumference;

          circle.style.strokeDashoffset = offset;

          const colors = {
            good: "#10b981",
            moderate: "#f59e0b",
            unhealthy_sensitive: "#f97316",
            unhealthy: "#dc2626",
            very_unhealthy: "#7c3aed",
          };
          circle.style.stroke = colors[this.getAQICategory(aqi)] || "#10b981";
        }

        updatePollutantGauges(pollutants) {
          const container = document.getElementById("pollutantGauges");
          if (!container) return;

          container.innerHTML = "";
          const maxValues = {
            NO2: 100,
            O3: 200,
            "PM2.5": 50,
            PM10: 100,
            SO2: 50,
            CO: 5,
          };

          Object.entries(pollutants).forEach(([name, data]) => {
            const percentage = Math.min(
              (data.value / (maxValues[name] || 100)) * 100,
              100,
            );
            const gauge = document.createElement("div");
            gauge.className = "pollutant-gauge";
            gauge.innerHTML = `
                <div class="gauge-circle">
                    <div class="gauge-bg"></div>
                    <div class="gauge-fill" style="--gauge-percentage: ${percentage}%"></div>
                    <div class="gauge-value">${data.value}</div>
                </div>
                <div style="font-size: 0.875rem; color: var(--color-text-secondary);">${name}</div>
                <div style="font-size: 0.75rem; opacity: 0.7;">${data.unit}</div>
            `;
            container.appendChild(gauge);
          });
        }

        updateForecastTimeline() {
          const timeline = document.getElementById("forecastTimeline");
          if (!timeline) return;

          const forecast = this.data.air_quality_data.forecast_data.slice(0, 6);
          timeline.innerHTML = forecast
            .map((item) => {
              const time = new Date(item.timestamp);
              const category = this.getAQICategory(item.aqi);
              return `
                <div class="timeline-item">
                    <div style="font-size: 0.75rem; color: var(--color-text-secondary);">
                        ${time.toLocaleTimeString("en-US", { hour: "numeric" })}
                    </div>
                    <div class="timeline-aqi">${item.aqi}</div>
                    <div style="font-size: 0.75rem;">${this.getAQICategoryName(category).split(" ")[0]}</div>
                </div>
            `;
            })
            .join("");
        }

        renderMap() {
          const mapViz = document.getElementById("mapVisualization");
          const locations = document.getElementById("monitoringLocations");
          if (!mapViz || !locations) return;

          mapViz.innerHTML = "";
          locations.innerHTML = "";

          this.data.monitoring_locations.forEach((loc, idx) => {
            const marker = document.createElement("div");
            marker.className = `map-marker aqi-${this.getAQICategory(loc.aqi)}`;
            marker.dataset.city = loc.name;
            marker.textContent = loc.aqi;
            marker.style.cursor = "pointer";

            marker.addEventListener("mouseenter", (e) =>
              this.showMapTooltip(e, loc),
            );
            marker.addEventListener("mouseleave", () => this.hideMapTooltip());
            marker.addEventListener("click", () => {
              this.currentLocationIndex = idx;
              document.getElementById("locationSelect").value = idx;
              this.updateLocation();
            });

            if (idx === this.currentLocationIndex) {
              marker.classList.add("selected");
            }

            mapViz.appendChild(marker);

            const card = document.createElement("div");
            card.className = `glass-card location-card ${idx === this.currentLocationIndex ? "selected" : ""}`;
            card.innerHTML = `
                <div style="position: absolute; top: 1rem; right: 1rem;">${loc.trend === "improving" ? "üìà" : loc.trend === "worsening" ? "üìâ" : "‚û°Ô∏è"}</div>
                <div style="font-weight: 600; font-size: 1.125rem;">${loc.name}</div>
                <div class="location-aqi">${loc.aqi}</div>
                <div style="font-size: 0.875rem; color: var(--color-text-secondary);">${this.getAQICategoryName(this.getAQICategory(loc.aqi))}</div>
            `;
            card.addEventListener("click", () => {
              this.currentLocationIndex = idx;
              document.getElementById("locationSelect").value = idx;
              this.updateLocation();
            });
            locations.appendChild(card);
          });
        }

        showMapTooltip(event, location) {
          const tooltip = document.getElementById("mapTooltip");
          if (!tooltip) return;

          tooltip.innerHTML = `
            <div><strong>${location.name}</strong></div>
            <div>AQI: ${location.aqi}</div>
            <div>${this.getAQICategoryName(this.getAQICategory(location.aqi))}</div>
        `;

          tooltip.style.left = `${event.pageX - 60}px`;
          tooltip.style.top = `${event.pageY - 80}px`;
          tooltip.classList.add("visible");
        }

        hideMapTooltip() {
          const tooltip = document.getElementById("mapTooltip");
          if (tooltip) tooltip.classList.remove("visible");
        }

        renderCharts() {
          const ctx = document.getElementById("historicalChart");
          if (!ctx) return;

          const historical = this.data.air_quality_data.historical_data;
          const labels = historical.map((d) =>
            new Date(d.timestamp).toLocaleTimeString("en-US", {
              hour: "numeric",
            }),
          );
          const aqiData = historical.map((d) => d.aqi);

          this.charts.historical = new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "AQI",
                  data: aqiData,
                  borderColor: "rgb(31, 184, 205)",
                  backgroundColor: "rgba(31, 184, 205, 0.1)",
                  fill: true,
                  tension: 0.4,
                  pointRadius: 3,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  backgroundColor: "rgba(0, 0, 0, 0.8)",
                  padding: 12,
                  cornerRadius: 8,
                },
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: 200,
                  grid: { color: "rgba(255, 255, 255, 0.1)" },
                  ticks: { color: "rgba(255, 255, 255, 0.7)" },
                },
                x: {
                  grid: { display: false },
                  ticks: { color: "rgba(255, 255, 255, 0.7)" },
                },
              },
            },
          });
        }

        renderForecastChart() {
          const ctx = document.getElementById("forecastChart");
          if (!ctx) return;

          const forecast = this.data.air_quality_data.forecast_data;
          const labels = forecast.map((d) =>
            new Date(d.timestamp).toLocaleTimeString("en-US", {
              hour: "numeric",
            }),
          );
          const aqiData = forecast.map((d) => d.aqi);

          if (this.charts.forecast) this.charts.forecast.destroy();

          this.charts.forecast = new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  label: "AQI Forecast",
                  data: aqiData,
                  borderColor: "rgb(33,128,141)",
                  backgroundColor: "rgba(33,128,141,0.1)",
                  fill: true,
                  tension: 0.3,
                  pointRadius: 2,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              color: "white",
              plugins: { legend: { display: false } },
              scales: {
                y: {
                  beginAtZero: true,
                  max: 200,
                  ticks: { color: "rgba(255, 255, 255, 0.7)" },
                  grid: { color: "rgba(255,255,255,0.1)" },
                },
                x: {
                  ticks: { color: "rgba(255, 255, 255, 0.7)" },
                  grid: { color: "rgba(255,255,255,0.05)" },
                },
              },
            },
          });
        }

        exportData() {
          const csv = this.generateCSV();
          const blob = new Blob([csv], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `air-quality-${new Date().toISOString().slice(0, 10)}.csv`;
          a.click();
          URL.revokeObjectURL(url);
          this.showToast("Data exported successfully!");
        }

        generateCSV() {
          const current = this.data.air_quality_data.current_conditions;
          let csv =
            "Location,AQI,Dominant Pollutant,Temperature,Humidity,Wind Speed\n";
          csv += `${current.location.name},${current.aqi},${current.dominant_pollutant},${current.weather.temperature},${current.weather.humidity},${current.weather.wind_speed}\n`;
          return csv;
        }

        getAQICategory(aqi) {
          if (aqi <= 50) return "good";
          if (aqi <= 100) return "moderate";
          if (aqi <= 150) return "unhealthy_sensitive";
          if (aqi <= 200) return "unhealthy";
          return "very_unhealthy";
        }

        getAQICategoryName(category) {
          const names = {
            good: "Good",
            moderate: "Moderate",
            unhealthy_sensitive: "Unhealthy for Sensitive",
            unhealthy: "Unhealthy",
            very_unhealthy: "Very Unhealthy",
          };
          return names[category] || "Unknown";
        }

        startRealTimeUpdates() {
          setInterval(() => {
            const now = new Date();
            document.getElementById("lastUpdate").textContent =
              now.toLocaleTimeString("en-US", {
                hour: "numeric",
                minute: "2-digit",
              });
          }, 60000);
        }

        async simulateLoading(ms) {
          return new Promise((resolve) => setTimeout(resolve, ms));
        }

        showToast(message, type = "info") {
          const container = document.getElementById("toastContainer");
          if (!container) return;

          const toast = document.createElement("div");
          toast.className = "toast";
          toast.textContent = message;

          if (type === "error") {
            toast.style.background = "rgba(220, 38, 38, 0.85)"; // red for danger
          } else if (type === "success") {
            toast.style.background = "rgba(16, 185, 129, 0.85)"; // green
          } else {
            toast.style.background = "rgba(0, 0, 0, 0.8)"; // default
          }

          container.appendChild(toast);

          setTimeout(() => {
            toast.remove();
          }, 5000);
        }
      }

      new AirFlowIntelligence();
    </script>
  </body>
</html>
